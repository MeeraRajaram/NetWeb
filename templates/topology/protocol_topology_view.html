<!DOCTYPE html>
<html>
<head>
    <title>Protocol Topology Visualization</title>
    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <style>
        #network {
            width: 100%;
            height: 600px;
            border: 1px solid lightgray;
            background: #fafbfc;
        }
    </style>
</head>
<body>
    <h2>Protocol Topology</h2>
    <a href="/topology" style="display:inline-block;margin-bottom:16px;padding:8px 16px;background:#eee;border-radius:6px;text-decoration:none;font-weight:bold;">Return</a>
    <div style="margin-bottom:16px;">
        <button onclick="showAll()">Show All</button>
        <button onclick="showOSPF()">Show OSPF</button>
        <button onclick="showStatic()">Show Static</button>
        <button onclick="showBasic()">Show Basic Topology</button>
    </div>
    <div id="network"></div>
    <script type="text/javascript">
        // no-lint: Jinja2 template variables used below
        var nodes = {{ nodes|tojson }};
        nodes.forEach(function(n) {
            if (n.type === 'router') {
                n.group = 'router';
            } else if (n.type === 'foreign') {
                n.group = 'foreign';
            }
            delete n.x; delete n.y; delete n.fixed;
        });
        var edges = {{ edges|tojson }};
        edges.forEach(function(e) {
            e.arrows = { to: { enabled: true, scaleFactor: 1.2 } };
            e.smooth = { type: 'continuous' };
            e.font = {
                size: 18,
                align: 'top',
                strokeWidth: 0,
                vadjust: -18
            };
            if (e.label && e.label.startsWith('Static')) {
                e.dashes = true;
                e.color = { color: '#888', highlight: '#888', inherit: false };
            } else if (e.label && e.label.startsWith('OSPF')) {
                e.dashes = false;
                e.color = { color: '#e67e22', highlight: '#e67e22', inherit: false };
            }
        });
        var allEdges = edges.slice();
        var container = document.getElementById('network');
        // Assign curvature to parallel edges to avoid overlap
        function assignEdgeCurvature(edges) {
            // Group edges by (from,to) and (to,from) for bidirectional
            var edgeGroups = {};
            edges.forEach(function(e, idx) {
                var key = e.from + '-' + e.to;
                if (!edgeGroups[key]) edgeGroups[key] = [];
                edgeGroups[key].push(e);
            });
            // Assign roundness for each group
            Object.values(edgeGroups).forEach(function(group) {
                if (group.length > 1) {
                    var base = 0.2;
                    var step = 0.15;
                    var mid = Math.floor(group.length / 2);
                    group.forEach(function(e, i) {
                        var offset = (i - mid) * step;
                        if (group.length % 2 === 0 && i >= mid) offset += step/2;
                        e.smooth = {
                            type: 'curvedCW',
                            roundness: base + Math.abs(offset)
                        };
                        // If edge is in reverse direction, use CCW
                        if (e.from > e.to) {
                            e.smooth.type = 'curvedCCW';
                        }
                    });
                }
            });
        }
        assignEdgeCurvature(edges);
        var data = {
            nodes: new vis.DataSet(nodes),
            edges: new vis.DataSet(edges)
        };
        var options = {
            layout: {
                improvedLayout: true,
                randomSeed: 42
            },
            physics: {
                enabled: false
            },
            nodes: {
                borderWidth: 2,
                shape: 'ellipse',
                font: {
                    size: 20,
                    face: 'arial',
                    color: '#222',
                    strokeWidth: 0,
                    vadjust: 0,
                    scaling: {
                        min: 14,
                        max: 32,
                        label: true
                    }
                }
            },
            groups: {
                router: {
                    color: { background: '#3498db', border: '#2980b9' },
                    font: { color: '#222' }
                },
                foreign: {
                    color: { background: '#f39c12', border: '#e67e22' },
                    font: { color: '#222' }
                }
            },
            edges: {
                smooth: { type: 'continuous' },
                font: {
                    size: 18,
                    align: 'top',
                    strokeWidth: 0,
                    vadjust: -18,
                    scaling: {
                        min: 12,
                        max: 28,
                        label: true
                    }
                },
                arrows: { to: { enabled: true, scaleFactor: 1.2 } }
            },
            interaction: {
                hover: true,
                dragNodes: true,
                dragView: true,
                zoomView: true,
                navigationButtons: true,
                keyboard: true
            },
            manipulation: {
                enabled: false
            }
        };
        var network = new vis.Network(container, data, options);
        network.on('selectNode', function(params) {
            // Placeholder for cluster expansion logic
        });
        function showAll() {
            data.edges.clear();
            data.edges.add(allEdges);
        }
        function showOSPF() {
            data.edges.clear();
            data.edges.add(allEdges.filter(function(e) { return e.label && e.label.startsWith('OSPF'); }));
        }
        function showStatic() {
            data.edges.clear();
            data.edges.add(allEdges.filter(function(e) { return e.label && e.label.startsWith('Static'); }));
        }
        function showBasic() {
            data.edges.clear();
            data.edges.add(allEdges.filter(function(e) { return e.dashes === true; }));
        }
    </script>
    <h3>Protocol Routes Table</h3>
    <table border="1" cellpadding="6" style="margin-top:24px;">
        <tr>
            <th>Source Router</th>
            <th>Destination</th>
            <th>Protocol</th>
            <th>Source Interface</th>
            <th>Source IP</th>
            <th>Next Hop</th>
        </tr>
        {% for row in proto_routes_rows %}
        <tr>
            <td>{{ row[0] }}</td>
            <td>{{ row[1] }}</td>
            <td>{{ row[2] }}</td>
            <td>{{ row[3] }}</td>
            <td>{{ row[4] }}</td>
            <td>{{ row[5] }}</td>
        </tr>
        {% endfor %}
    </table>
</body>
</html> 